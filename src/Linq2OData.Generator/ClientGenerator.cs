using Linq2OData.Generator.Models;
using Linq2OData.Generator.Templates.Client;
using Linq2OData.Generator.Templates.Types;


namespace Linq2OData.Generator;

public class ClientGenerator(ClientRequest request)
{

    private List<FileEntry> files = [];
    private List<ODataMetadata> metadataCollection = [];

    public List<FileEntry> GenerateClient()
    {
        files.Clear();

          //Parse Metadata
        foreach (var metadataContent in request.MetadataList)
        {
            var metadata = Metadata.MetadataParser.Parse(metadataContent);
            metadataCollection.Add(metadata);
        }

        GenerateTypesCode();

        GenerateClientCode();



        return files;
    }

    public List<FileEntry> GenerateClient(string outputFolder)
    {
        var files = GenerateClient();

        foreach (var file in files) { 

            var directoryPath = Path.Combine(outputFolder, file.FolderPath);
            if (!Directory.Exists(directoryPath))
            {
                Directory.CreateDirectory(directoryPath);
            }
            var filePath = Path.Combine(directoryPath, file.FileName);
            File.WriteAllText(filePath, file.Content);

        }

        return files;
    }


    private void GenerateClientCode()
    {
        var templateText = new ClientTemplate(request.Name, request.Namespace, metadataCollection).TransformText();
        AddFile("Client", request.Name + ".cs", templateText);


        //Generate Endpoints
        foreach (var metadata in metadataCollection)
        {
            var fullNamspace = request.Namespace + "." + metadata.Namespace;
            var contextText = new ClientEndpointTemplate(fullNamspace, metadata).TransformText();
            AddFile("Client", metadata.EndpointName + ".cs" , contextText);
        }


    }
    private void GenerateTypesCode()
    {
        foreach (var metadata in metadataCollection)
        {
            var fullNamspace = request.Namespace + "." + metadata.Namespace;

            foreach (var entityType in metadata.EntityTypes)
            {
                var classText = new TypeTemplate(entityType, fullNamspace).TransformText();
                AddFile("Types", entityType.Name + ".cs", classText);
            }
        }
    

    }


    private void AddFile(string directoryName, string fileName, string content)
    {
        var infoText = $@"//---------------------------------------------------------------------
// This code was automatically generated by Linq2OData
// Please don't edit this file
//---------------------------------------------------------------------

";
        //content = infoText + content;


        files.Add(new FileEntry
        {
            FolderPath = directoryName,
            FileName = fileName,
            Content = content
        });
    }


}
