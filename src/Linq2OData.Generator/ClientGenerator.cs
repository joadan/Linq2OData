using Linq2OData.Core;
using Linq2OData.Core.Metadata;
using Linq2OData.Generator.Models;
using Linq2OData.Generator.Templates.Client;
using Linq2OData.Generator.Templates.Input;
using Linq2OData.Generator.Templates.Types;


namespace Linq2OData.Generator;

public class ClientGenerator(ClientRequest request)
{
    private List<FileEntry> files = [];
    //private List<ODataMetadata> metadataCollection = [];
    private ODataVersion? version = null;

    public List<FileEntry> GenerateClient()
    {

        files.Clear();

        if (request.Metadata == null || request.Metadata.Count == 0)
        {
            throw new Exception("At least one metadata document must be provided.");
        }


        //Check/Set version Metadata
        foreach (var requestMetadata in request.Metadata)
        {

            if (version != null && requestMetadata.Metadata.ODataVersion != version)
            {
                throw new Exception($"All metadata documents must have the same OData version. Current is {version.ToString()}, trying to add {requestMetadata.Metadata.Namespace}: {requestMetadata.Metadata.ODataVersion}");
            }
            else
            {
                version = requestMetadata.Metadata.ODataVersion;
            }

        }

        GenerateTypesCode();
        GenerateClientCode();
        GenerateInputTypesCode();
        AddSharedCode();

        return files;
    }



    public List<FileEntry> GenerateClient(string outputFolder)
    {
        var files = GenerateClient();

        foreach (var file in files)
        {

            var directoryPath = Path.Combine(outputFolder, file.FolderPath);
            if (!Directory.Exists(directoryPath))
            {
                Directory.CreateDirectory(directoryPath);
            }
            var filePath = Path.Combine(directoryPath, file.FileName);
            File.WriteAllText(filePath, file.Content);

        }

        return files;
    }

    private void AddSharedCode()
    {

        //var sharedPath = Path.Combine("Dependencies", "Linq2OData.Client");

        //if(Directory.Exists(sharedPath))
        //{
        //    var sharedFiles = Directory.GetFiles(sharedPath, "*.cs", SearchOption.AllDirectories);
        //    foreach (var sharedFile in sharedFiles)
        //    {
        //        //var relativePath = Path.GetRelativePath(sharedPath, sharedFile);
        //        var fileContent = File.ReadAllText(sharedFile);
        //        AddFile(Path.GetDirectoryName(sharedFile)!.Replace("\\", "/"), Path.GetFileName(sharedFile), fileContent);
        //    }
        //}

        //var files =   Directory.GetFiles(Path.Combine("Dependencies", "Linq2OData.Client"), "*.cs", SearchOption.AllDirectories);

    }

    private void GenerateClientCode()
    {
        var templateText = new ClientTemp(request, (ODataVersion)version!).TransformText();
        AddFile("Client", request.Name + ".cs", templateText);

        var templateHelperText = new ClientHelperTemplate(request).TransformText();
        AddFile("Client", request.Name + "Helpers.cs", templateHelperText);

    }

    private void GenerateTypesCode()
    {
        foreach (var clientMetadata in request.Metadata)
        {
            var metadata = clientMetadata.Metadata;
            var fullNamspace = request.Namespace + "." + metadata.Namespace;

            // Generate enums
            foreach (var enumType in metadata.EnumTypes)
            {
                var enumText = new Templates.Types.EnumTemplate(enumType, fullNamspace).TransformText();
                AddFile("Enums", enumType.Name + ".cs", enumText);
            }

            // Generate entity and complex types
            foreach (var entityType in metadata.EntityTypes)
            {
                var classText = new TypeTemplate(entityType, fullNamspace, clientMetadata.ServicePath, request.InterfaceName, metadata.GetDerivedTypes(entityType.Name), metadata.Namespace, (ODataVersion)version!).TransformText();
                AddFile("Types", entityType.Name + ".cs", classText);
            }
        }
    }

    private void GenerateInputTypesCode()
    {
        foreach (var clientMetadata in request.Metadata)
        {
            var metadata = clientMetadata.Metadata;
            var fullNamspace = request.Namespace + "." + metadata.Namespace;

            foreach (var entityType in metadata.EntityTypes)
            {
                var classText = new InputTemplate(entityType, fullNamspace).TransformText();
                AddFile("Inputs", entityType.InputName + ".cs", classText);
            }
        }
    }


    private void AddFile(string directoryName, string fileName, string content)
    {
        var infoText = $@"// <auto-generated>
//     This code was generated by Linq2OData, https://github.com/joadan/Linq2OData/ 
//     Changes to this sharedFile may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>

#nullable enable
";

        content = infoText + content;

        files.Add(new FileEntry
        {
            FolderPath = directoryName,
            FileName = fileName,
            Content = content
        });
    }
}
